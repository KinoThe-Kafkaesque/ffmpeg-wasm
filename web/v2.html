<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FFmpeg WASM Matroska Player v2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles-v2.css" />
  </head>
  <body>
    <div class="app-container">
      <header>
        <div>
          <h1>FFmpeg Player</h1>
          <p>High-performance WASM Matroska playback</p>
        </div>
        <div class="header-status" id="status">Loading module...</div>
      </header>

      <main class="main-content">
        <!-- Left Column: Player -->
        <section class="player-section" id="player">
          <div class="video-container" id="canvasWrap">
            <canvas id="canvas2d"></canvas>
            <canvas id="canvasGl" class="is-hidden"></canvas>

            <!-- OSD (On-Screen Display) -->
            <div id="osd" class="osd"></div>

            <!-- Floating Controls Overlay -->
            <div class="controls-overlay">
              <div class="controls-row">
                <input
                  id="seekRange"
                  type="range"
                  min="0"
                  max="0"
                  step="0.01"
                  value="0"
                  disabled
                />
              </div>
              <div class="controls-row bottom">
                <div class="controls-left">
                  <button id="overlayPlay" title="Play">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                  </button>
                  <button id="overlayPause" title="Pause" style="display: none">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <rect x="6" y="4" width="4" height="16"></rect>
                      <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                  </button>
                  <button id="overlayStop" class="btn-danger" title="Stop">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <rect
                        x="3"
                        y="3"
                        width="18"
                        height="18"
                        rx="2"
                        ry="2"
                      ></rect>
                    </svg>
                  </button>

                  <div class="volume-control">
                    <button id="overlayMute" title="Mute">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <polygon
                          points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"
                        ></polygon>
                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                      </svg>
                    </button>
                    <input
                      id="overlayVolume"
                      type="range"
                      min="0"
                      max="1"
                      step="0.01"
                      value="0.8"
                    />
                  </div>

                  <div class="time-display">
                    <span id="timeCurrent">0:00</span> /
                    <span id="timeTotal">--:--</span>
                  </div>
                </div>

                <div class="controls-right">
                  <span
                    id="speedDisplay"
                    class="speed-display"
                    title="Playback speed"
                    >1x</span
                  >

                  <button id="screenshotBtn" title="Screenshot (S)">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                      <circle cx="8.5" cy="8.5" r="1.5" />
                      <polyline points="21 15 16 10 5 21" />
                    </svg>
                  </button>

                  <button id="overlayFullscreen" title="Fullscreen (F)">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"
                      />
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Stats Panel -->
          <div class="panel">
            <div class="panel-header">Statistics</div>
            <div class="stats-grid">
              <div class="stat-item">
                <span class="stat-label">Resolution</span>
                <span class="stat-value" id="resolution">-</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Frames</span>
                <span class="stat-value" id="frameCount">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Buffered</span>
                <span class="stat-value" id="bytesCount">0 B</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">PTS</span>
                <span class="stat-value" id="ptsValue">0.00s</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Audio Format</span>
                <span class="stat-value" id="audioInfo">-</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Audio Clock</span>
                <span class="stat-value" id="audioClock">0.00s</span>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">Logs</div>
            <pre id="log" class="log-container"></pre>
          </div>
        </section>

        <!-- Right Column: Settings -->
        <aside class="sidebar">
          <div class="panel">
            <div class="panel-header">Source</div>

            <div class="form-group">
              <label for="fileInput">Local File</label>
              <div class="file-input-wrapper">
                <button class="form-control" style="text-align: left">
                  Choose File...
                </button>
                <input
                  id="fileInput"
                  type="file"
                  accept="video/*,.mkv,video/x-matroska"
                />
              </div>
              <div class="hint-text">Matroska (MKV) recommended</div>
            </div>

            <div class="form-group">
              <label for="urlInput">Stream URL</label>
              <input
                id="urlInput"
                type="url"
                class="form-control"
                placeholder="https://example.com/video.mkv"
              />
              <div class="hint-text">CORS required for external URLs</div>
            </div>

            <div class="form-row">
              <button id="startBtn" class="btn-primary w-full" disabled>
                Start Playback
              </button>
            </div>

            <!-- Hidden buttons referenced by logic but exposed in overlay -->
            <div style="display: none">
              <button id="pauseBtn" disabled>Pause</button>
              <button id="stopBtn" disabled>Stop</button>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">Settings</div>

            <div class="form-group">
              <label for="formatSelect">Container Hint</label>
              <select id="formatSelect" class="form-control">
                <option value="">Auto detect</option>
                <option value="mov">MP4 / QuickTime (mov)</option>
                <option value="matroska" selected>Matroska / WebM</option>
              </select>
            </div>

            <div class="form-group">
              <label for="renderMode">Render Mode</label>
              <select id="renderMode" class="form-control">
                <option value="2d" selected>Canvas 2D</option>
                <option value="webgl">WebGL</option>
              </select>
            </div>

            <div class="form-group">
              <label for="videoTrackSelect">Video Track</label>
              <select id="videoTrackSelect" class="form-control" disabled>
                <option value="-1" selected>Auto</option>
              </select>
            </div>

            <div class="form-group">
              <label for="audioTrackSelect">Audio Track</label>
              <select id="audioTrackSelect" class="form-control" disabled>
                <option value="-1" selected>Auto</option>
                <option value="-2">None</option>
              </select>
            </div>

            <div class="form-group">
              <label for="subtitleTrackSelect">Subtitle Track</label>
              <select id="subtitleTrackSelect" class="form-control" disabled>
                <option value="-2" selected>None</option>
                <option value="-1">Auto</option>
              </select>
            </div>

            <div class="form-group">
              <label for="bufferSize">Initial Buffer (MB)</label>
              <input
                id="bufferSize"
                type="number"
                class="form-control"
                min="1"
                max="64"
                value="4"
              />
            </div>

            <div class="form-group">
              <div
                class="flex-center"
                style="justify-content: space-between; margin-bottom: 8px"
              >
                <label for="volumeRange" style="margin: 0">Master Volume</label>
                <span id="volumeValue" class="stat-value">80%</span>
              </div>
              <input
                id="volumeRange"
                type="range"
                min="0"
                max="1"
                step="0.01"
                value="0.8"
              />
            </div>
          </div>

          <!-- Playback Settings -->
          <div class="panel">
            <div class="panel-header">Playback</div>

            <div class="form-group">
              <label for="speedSelect">Speed</label>
              <select id="speedSelect" class="form-control">
                <option value="0.25">0.25x</option>
                <option value="0.5">0.5x</option>
                <option value="0.75">0.75x</option>
                <option value="1" selected>1x (Normal)</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
                <option value="1.75">1.75x</option>
                <option value="2">2x</option>
              </select>
              <div class="hint-text">[ / ] keys to cycle</div>
            </div>

            <div class="form-group">
              <label for="aspectRatioSelect">Aspect Ratio</label>
              <select id="aspectRatioSelect" class="form-control">
                <option value="auto" selected>Auto</option>
                <option value="16:9">16:9</option>
                <option value="4:3">4:3</option>
                <option value="fill">Fill</option>
                <option value="stretch">Stretch</option>
              </select>
            </div>

            <div class="form-group">
              <label>A-B Loop</label>
              <div class="loop-controls">
                <button
                  id="loopStartBtn"
                  class="btn-sm"
                  title="Set loop start (A)"
                >
                  A
                </button>
                <button id="loopEndBtn" class="btn-sm" title="Set loop end (B)">
                  B
                </button>
                <button id="loopToggle" class="btn-sm" title="Toggle loop (P)">
                  ⟳
                </button>
                <span id="loopDisplay" class="loop-display">Not set</span>
              </div>
              <div class="hint-text">A/B keys to set points, P to toggle</div>
            </div>
          </div>

          <!-- Audio/Subtitle Sync -->
          <div class="panel">
            <div class="panel-header">Sync</div>

            <div class="form-group">
              <div
                class="flex-center"
                style="justify-content: space-between; margin-bottom: 8px"
              >
                <label for="audioDelayInput" style="margin: 0"
                  >Audio Delay</label
                >
                <span id="audioDelayValue" class="stat-value">0ms</span>
              </div>
              <input
                id="audioDelayInput"
                type="range"
                min="-5000"
                max="5000"
                step="50"
                value="0"
              />
              <div class="hint-text">Shift+J/L keys ±100ms</div>
            </div>

            <div class="form-group">
              <label for="subtitleTrackSelect">Subtitle Track</label>
              <select id="subtitleTrackSelect" class="form-control" disabled>
                <option value="-2" selected>None</option>
                <option value="-1">Auto</option>
              </select>
            </div>

            <div class="form-group">
              <div
                class="flex-center"
                style="justify-content: space-between; margin-bottom: 8px"
              >
                <label for="subtitleDelayInput" style="margin: 0"
                  >Subtitle Delay</label
                >
                <span id="subtitleDelayValue" class="stat-value">0ms</span>
              </div>
              <input
                id="subtitleDelayInput"
                type="range"
                min="-5000"
                max="5000"
                step="50"
                value="0"
              />
              <div class="hint-text">Z/X keys ±100ms</div>
            </div>
          </div>

          <!-- Video Filters -->
          <div class="panel">
            <div class="panel-header">
              <span>Filters</span>
              <button
                id="filtersReset"
                class="btn-sm btn-text"
                title="Reset filters"
              >
                Reset
              </button>
            </div>

            <div class="form-group">
              <div
                class="flex-center"
                style="justify-content: space-between; margin-bottom: 8px"
              >
                <label for="brightnessInput" style="margin: 0"
                  >Brightness</label
                >
                <span id="brightnessValue" class="stat-value filter-value"
                  >100%</span
                >
              </div>
              <input
                id="brightnessInput"
                type="range"
                min="0"
                max="200"
                step="5"
                value="100"
              />
            </div>

            <div class="form-group">
              <div
                class="flex-center"
                style="justify-content: space-between; margin-bottom: 8px"
              >
                <label for="contrastInput" style="margin: 0">Contrast</label>
                <span id="contrastValue" class="stat-value filter-value"
                  >100%</span
                >
              </div>
              <input
                id="contrastInput"
                type="range"
                min="0"
                max="200"
                step="5"
                value="100"
              />
            </div>

            <div class="form-group">
              <div
                class="flex-center"
                style="justify-content: space-between; margin-bottom: 8px"
              >
                <label for="saturationInput" style="margin: 0"
                  >Saturation</label
                >
                <span id="saturationValue" class="stat-value filter-value"
                  >100%</span
                >
              </div>
              <input
                id="saturationInput"
                type="range"
                min="0"
                max="200"
                step="5"
                value="100"
              />
            </div>
          </div>

          <!-- Keyboard Shortcuts Reference -->
          <div class="panel collapsible">
            <div
              class="panel-header panel-toggle"
              onclick="this.parentElement.classList.toggle('collapsed')"
            >
              <span>Keyboard Shortcuts</span>
              <span class="collapse-icon">▼</span>
            </div>
            <div class="panel-content">
              <div class="shortcuts-grid">
                <div class="shortcut"><kbd>Space</kbd> Play/Pause</div>
                <div class="shortcut"><kbd>←</kbd><kbd>→</kbd> Seek ±5s</div>
                <div class="shortcut">
                  <kbd>Shift</kbd>+<kbd>←</kbd><kbd>→</kbd> ±30s
                </div>
                <div class="shortcut"><kbd>J</kbd><kbd>L</kbd> Seek ±10s</div>
                <div class="shortcut"><kbd>↑</kbd><kbd>↓</kbd> Volume</div>
                <div class="shortcut"><kbd>M</kbd> Mute</div>
                <div class="shortcut"><kbd>F</kbd> Fullscreen</div>
                <div class="shortcut"><kbd>S</kbd> Screenshot</div>
                <div class="shortcut"><kbd>,</kbd><kbd>.</kbd> Frame step</div>
                <div class="shortcut"><kbd>[</kbd><kbd>]</kbd> Speed</div>
                <div class="shortcut"><kbd>\</kbd> Reset speed</div>
                <div class="shortcut"><kbd>A</kbd><kbd>B</kbd> Loop points</div>
                <div class="shortcut"><kbd>P</kbd> Toggle loop</div>
                <div class="shortcut"><kbd>C</kbd> Clear loop</div>
                <div class="shortcut">
                  <kbd>Shift</kbd>+<kbd>J</kbd><kbd>L</kbd> Audio delay
                </div>
                <div class="shortcut"><kbd>Z</kbd><kbd>X</kbd> Sub delay</div>
                <div class="shortcut"><kbd>0-9</kbd> Jump to %</div>
                <div class="shortcut"><kbd>Esc</kbd> Exit/Stop</div>
              </div>
            </div>
          </div>
        </aside>
      </main>
    </div>

    <script type="module" src="app-v2.js"></script>
  </body>
</html>
